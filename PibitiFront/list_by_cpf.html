<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Buscar Paciente por CPF</title>
<link rel="stylesheet" href="style.css" />
<style>
    table {
        width: 100% !important;
        min-width: 1100px;
        table-layout: fixed;
        border-collapse: collapse;
    }

    .container, .form-container {
      width: 100vw;
      max-width: 100vw;
      padding: 10px 20px;
      box-sizing: border-box;
    }

    .table-container {
      overflow-x: visible !important;
    }

    table th, table td {
      padding: 8px 6px;
      word-wrap: break-word;
      white-space: normal;
      text-align: center;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    thead tr {
      background-color: #0077b6;
      color: white;
    }

    table button {
      padding: 5px 8px;
      font-size: 0.85rem;
      border-radius: 4px;
      cursor: pointer;
    }

    @media (max-width: 700px) {
      table th, table td {
        font-size: 0.8rem;
        padding: 6px 4px;
      }
      button {
        padding: 4px 6px;
        font-size: 0.75rem;
      }
    }
</style>
</head>
<body>
    <div class="form-container">
        <h2>Buscar Paciente por CPF</h2>
        <input type="text" id="cpfInput" placeholder="Digite o CPF" />
        <button id="btnBuscar">Buscar</button>
        <button id="btnVoltar">Voltar</button>

        <div class="table-container" style="margin-top:20px;">
            <table id="resultTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Pré-Hemoglobina</th>
                        <th>Pré-Hematócrito</th>
                        <th>Pré-Lactato</th>
                        <th>Altura (m)</th>
                        <th>CPB (min)</th>
                        <th>Anóxia (min)</th>
                        <th>Reoperação</th>
                        <th>Sexo</th>
                        <th>Paciente Febril</th>
                        <th>Probabilidade (%)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script type="module">
    import { API_BASE_URL } from './config.js';

    function mascararCPF(cpf) {
        if (!cpf || cpf.length < 5) return cpf;
        const inicio = cpf.slice(0, 3);
        const fim = cpf.slice(-2);
        const estrelas = '*'.repeat(cpf.length - 5);
        return inicio + estrelas + fim;
    }

    function mascararNome(nome) {
        if (!nome) return nome;
        const partes = nome.trim().split(" ");
        if (partes.length <= 2) return nome;
        return `${partes[0]} ***** ${partes[partes.length - 1]}`;
    }

    async function apiFetch(url, options = {}) {
        options.headers = {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true',
            ...(options.headers || {})
        };
        return fetch(`${API_BASE_URL}${url}`, options);
    }

    async function buscarPaciente() {
        const cpf = document.getElementById('cpfInput').value.trim();
        const table = document.getElementById('resultTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        if (!cpf) {
            alert('Informe um CPF');
            table.style.display = 'none';
            return;
        }

        const res = await apiFetch(`/paciente/${cpf}`);
        if (!res.ok) {
            alert('Paciente não encontrado');
            table.style.display = 'none';
            return;
        }

        const data = await res.json();
        const p = data.message;

        const tr = document.createElement('tr');

        const btnDeletar = document.createElement('button');
        btnDeletar.textContent = 'Deletar';
        btnDeletar.addEventListener('click', () => deletarPaciente(p.cpf));

        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.addEventListener('click', () => editarPaciente(p.cpf));

        tr.innerHTML = `
            <td>${mascararNome(p.nome)}</td>
            <td>${mascararCPF(p.cpf)}</td>
            <td>${p.pre_hemoglobin}</td>
            <td>${p.pre_hematocrit}</td>
            <td>${p.pre_lactate}</td>
            <td>${p.height}</td>
            <td>${p.cpb}</td>
            <td>${p.anoxia}</td>
            <td>${p.redo == 1 ? 'Sim' : 'Não'}</td>
            <td>${p.female == 1 ? 'Feminino' : 'Masculino'}</td>
            <td>${p.normothermia == 1 ? 'Não' : 'Sim'}</td>
            <td>${parseFloat(p.probability).toFixed(4)}</td>
            <td></td>
        `;
        tr.querySelector('td:last-child').appendChild(btnDeletar);
        tr.querySelector('td:last-child').appendChild(btnEditar);

        tbody.appendChild(tr);
        table.style.display = 'table';
    }

    async function deletarPaciente(cpf) {
        if (!confirm('Confirma a exclusão deste paciente?')) return;

        const res = await apiFetch(`/paciente/delete/${cpf}`, { method: 'DELETE' });
        if (res.ok) {
            alert('Paciente deletado');
            buscarPaciente();
        } else {
            alert('Erro ao deletar paciente');
        }
    }

    function editarPaciente(cpf) {
        sessionStorage.setItem('cpf_to_edit', cpf);
        window.location.href = 'update_patient.html';
    }

    document.getElementById('btnBuscar').addEventListener('click', buscarPaciente);
    document.getElementById('btnVoltar').addEventListener('click', () => {
        window.location.href = 'list_options.html';
    });
</script>
</body>
</html>
